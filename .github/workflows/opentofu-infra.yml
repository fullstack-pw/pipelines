name: OpenTofu

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      clusters: ${{ steps.filter.outputs.clusters }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            clusters:
              - 'clusters/**'
              - 'secrets/**'

  plan-clusters:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.clusters == 'true'
    runs-on: self-hosted
    environment: terraform
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: OpenTofu Init
        run: |
          make init

      - name: OpenTofu Plan
        id: plan
        run: |
          make plan
        continue-on-error: true

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: opentofu-clusters-plan
          path: clusters/plan.txt

      - name: Add Plan Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('./clusters/plan.txt', 'utf8');
            const truncatedOutput = planOutput.length > 65000
              ? planOutput.substring(0, 65000) + "\n\n... Output truncated due to size. See artifacts for full plan."
              : planOutput;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## OpenTofu Plan
              \`\`\`hcl
              ${truncatedOutput}
              \`\`\`

              Plan exit code: ${{ steps.plan.outcome == 'success' && '0' || '1' }}
              `
            })

  apply-clusters:
    needs: detect-changes
    if: github.event_name == 'push' && needs.detect-changes.outputs.clusters == 'true'
    runs-on: self-hosted
    environment: terraform
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Check if triggered by PR merge
        id: pr_check
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            COMMIT_MESSAGE=$(git log -1 --pretty=%B)
            PR_NUMBER=$(echo "$COMMIT_MESSAGE" | grep -oP 'Merge pull request #\K\d+' || echo "")

            if [ -n "$PR_NUMBER" ]; then
              echo "pr_merged=true" >> $GITHUB_OUTPUT
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "pr_merged=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "pr_merged=false" >> $GITHUB_OUTPUT
          fi

      - name: OpenTofu Init
        run: |
          make init

      - name: Capture OpenTofu Outputs Before Apply
        id: outputs_before
        run: |
          cd clusters
          mkdir -p /tmp/tofu-outputs

          for workspace in sandboxy tools observability; do
            tofu workspace select $workspace

            if tofu output -json proxmox_cluster_names 2>/dev/null | jq -e '. | length > 0' > /dev/null 2>&1; then
              tofu output -json proxmox_cluster_names > /tmp/tofu-outputs/${workspace}_clusters_before.json
              echo "Captured outputs for workspace: $workspace"
            else
              echo "[]" > /tmp/tofu-outputs/${workspace}_clusters_before.json
            fi
          done

      - name: OpenTofu Apply
        id: apply
        timeout-minutes: 30
        run: |
          make apply

      - name: Capture OpenTofu Outputs After Apply
        id: outputs_after
        if: steps.apply.outcome == 'success'
        run: |
          cd clusters

          for workspace in sandboxy tools observability; do
            tofu workspace select $workspace

            if tofu output -json proxmox_cluster_names 2>/dev/null | jq -e '. | length > 0' > /dev/null 2>&1; then
              tofu output -json proxmox_cluster_names > /tmp/tofu-outputs/${workspace}_clusters_after.json
            else
              echo "[]" > /tmp/tofu-outputs/${workspace}_clusters_after.json
            fi
          done

      - name: Detect Cluster Changes
        id: detect_changes
        if: steps.apply.outcome == 'success'
        run: |
          cd /tmp/tofu-outputs
          CHANGES_DETECTED=false
          CHANGED_WORKSPACES=""

          for workspace in sandboxy tools observability; do
            BEFORE=$(cat ${workspace}_clusters_before.json)
            AFTER=$(cat ${workspace}_clusters_after.json)

            if [ "$BEFORE" != "$AFTER" ]; then
              echo "Changes detected in workspace: $workspace"
              echo "Before: $BEFORE"
              echo "After: $AFTER"
              CHANGES_DETECTED=true
              CHANGED_WORKSPACES="$CHANGED_WORKSPACES $workspace"
            fi
          done

          echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_OUTPUT
          echo "changed_workspaces=$CHANGED_WORKSPACES" >> $GITHUB_OUTPUT

      - name: Wait for Clusters to Become Available
        if: steps.detect_changes.outputs.changes_detected == 'true'
        timeout-minutes: 30
        run: |
          cd /tmp/tofu-outputs

          ALL_NEW_CLUSTERS=""

          for workspace in sandboxy tools observability; do
            BEFORE=$(cat ${workspace}_clusters_before.json | jq -r '.[]' 2>/dev/null || echo "")
            AFTER=$(cat ${workspace}_clusters_after.json | jq -r '.[]' 2>/dev/null || echo "")

            for cluster in $AFTER; do
              if ! echo "$BEFORE" | grep -q "^${cluster}$"; then
                echo "Detected NEW cluster '$cluster' from OpenTofu workspace '$workspace'"
                ALL_NEW_CLUSTERS="$ALL_NEW_CLUSTERS $cluster"
              else
                echo "Skipping existing cluster '$cluster' in OpenTofu workspace '$workspace' (already exists)"
              fi
            done
          done

          for cluster in $ALL_NEW_CLUSTERS; do
            echo "Waiting for Cluster API object '$cluster' in namespace '$cluster' on tools cluster to become Available..."

            TIMEOUT=1800
            ELAPSED=0
            INTERVAL=10

            while [ $ELAPSED -lt $TIMEOUT ]; do
              AVAILABLE_STATUS=$(kubectl --kubeconfig /home/runner/.kube/config --context tools get cluster.cluster.x-k8s.io "$cluster" -n "$cluster" -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' 2>/dev/null || echo "")

              if [ "$AVAILABLE_STATUS" == "True" ]; then
                echo "Cluster '$cluster' is now Available!"
                break
              fi

              echo "Cluster '$cluster' not yet available (status: ${AVAILABLE_STATUS:-NotFound}), waiting... ($ELAPSED/$TIMEOUT seconds)"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "ERROR: Timeout waiting for cluster '$cluster' to become Available"
              echo "Cluster status:"
              kubectl --kubeconfig /home/runner/.kube/config --kubeconfig /home/runner/.kube/config --context tools get cluster.cluster.x-k8s.io "$cluster" -n "$cluster" -o yaml 2>/dev/null || echo "Cluster not found"
              exit 1
            fi
          done

          if [ -n "$ALL_NEW_CLUSTERS" ]; then
            echo "All new clusters are now Available!"
          else
            echo "No new clusters to wait for"
          fi

      - name: Update Kubeconfigs in SOPS and Commit
        if: steps.detect_changes.outputs.changes_detected == 'true'
        continue-on-error: true
        id: kubeconfig_update
        env:
          KUBECONFIG: ~/.kube/config
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          CHANGES_MADE=false

          cd /tmp/tofu-outputs
          for workspace in sandboxy tools observability; do
            echo "Processing workspace: $workspace"

            BEFORE=$(cat ${workspace}_clusters_before.json | jq -r '.[]' 2>/dev/null || echo "")
            AFTER=$(cat ${workspace}_clusters_after.json | jq -r '.[]' 2>/dev/null || echo "")

            for cluster in $AFTER; do
              echo "Upserting kubeconfig for: $cluster"
              cd "${GITHUB_WORKSPACE}"
              if ./clusters/scripts/update_kubeconfig_sops.sh "$cluster" "$cluster" "$workspace" upsert; then
                CHANGES_MADE=true
              else
                echo "Warning: Failed to upsert kubeconfig for $cluster"
              fi
              cd /tmp/tofu-outputs
            done

            for cluster in $BEFORE; do
              if ! echo "$AFTER" | grep -q "^${cluster}$"; then
                echo "Deleting kubeconfig for: $cluster"
                cd "${GITHUB_WORKSPACE}"
                if ./clusters/scripts/update_kubeconfig_sops.sh "$cluster" "$cluster" "$workspace" delete; then
                  CHANGES_MADE=true
                else
                  echo "Warning: Failed to delete kubeconfig for $cluster"
                fi
                cd /tmp/tofu-outputs
              fi
            done
          done

          cd "${GITHUB_WORKSPACE}"
          if [ "$CHANGES_MADE" == "true" ]; then
            if ! git diff --quiet secrets/common/cluster-secret-store/secrets/KUBECONFIG.yaml; then
              echo "Committing KUBECONFIG changes to git"

              git stash push -u -m "Temporary stash before pull"
              git pull --rebase origin main
              git stash pop

              git add secrets/common/cluster-secret-store/secrets/KUBECONFIG.yaml
              git commit -m "chore: Update KUBECONFIG with Cluster API clusters"
              git push

              echo "kubeconfig_updated=true" >> $GITHUB_OUTPUT
              echo "KUBECONFIG updated and committed to git"
            else
              echo "No changes to KUBECONFIG file detected"
              echo "kubeconfig_updated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No kubeconfig updates were made"
            echo "kubeconfig_updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync KUBECONFIG to Vault
        if: steps.kubeconfig_update.outputs.kubeconfig_updated == 'true'
        run: |
          echo "Running OpenTofu apply to sync KUBECONFIG changes to Vault (tools workspace, Vault resources only)"
          make apply ENV=tools TARGET='module.vault[0]'
          echo "KUBECONFIG successfully synced to Vault"

      - name: Report Kubeconfig Update Failure
        if: steps.pr_check.outputs.pr_merged == 'true' && steps.kubeconfig_update.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Warning: Kubeconfig Update Failed

              OpenTofu apply succeeded but kubeconfig extraction/update to SOPS failed.

              **Manual action required:**
              \`\`\`bash
              # Extract kubeconfig from Cluster API and update SOPS file manually
              kubectl --kubeconfig /home/runner/.kube/config --context <workspace> get secret <cluster>-kubeconfig -n <cluster> -o jsonpath='{.data.value}' | base64 -d > /tmp/new-kubeconfig
              ./secret_edit.sh secrets/common/cluster-secret-store/secrets/KUBECONFIG.yaml
              # Manually merge /tmp/new-kubeconfig into the SOPS file
              git add secrets/common/cluster-secret-store/secrets/KUBECONFIG.yaml
              git commit -m "chore: Add kubeconfig for <cluster>"
              git push
              # Next workflow run will sync to Vault automatically
              \`\`\`

              Check [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
              `
            })

      - name: Add Apply Comment
        if: steps.pr_check.outputs.pr_merged == 'true' && steps.apply.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## OpenTofu Apply

              Successfully applied OpenTofu changes to Kubernetes clusters.

              Apply completed at: ${new Date().toISOString()}
              `
            })

      - name: Add Apply Error Comment
        if: steps.pr_check.outputs.pr_merged == 'true' && steps.apply.outcome != 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.pr_check.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## OpenTofu Apply Failed

              Failed to apply OpenTofu changes to Kubernetes clusters.

              Please check the workflow logs for more details.
              `
            })
